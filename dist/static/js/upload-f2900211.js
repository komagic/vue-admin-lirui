import{l as pe,w as Z,v as ue}from"./@vue.runtime-dom-7b7b8a44.js";import{a as ce}from"./vuedraggable-e793fde8.js";import{J as de,u as me,P as fe}from"./@element-plus.icons-vue-e3809a99.js";import{u as _e,m as ge,y as he,j as M,o as ye}from"./index-8b7486b1.js";import{u as be}from"./index-7911eabc.js";import{_ as ve,g as ke,a as we,b as Se,c as Ce}from"./viewer.vue_vue_type_script_setup_true_name_item-viewer_lang-3fc5abe8.js";import{r as ee,q as ze}from"./lodash-es-d2af5045.js";import{a as T}from"./element-plus-e43e0101.js";import{d as te,q as v,p as xe,W as k,o as c,c as w,a as g,b as m,J as f,E as j,M as h,I as x,G as Be,F as oe,N as $e,K as Ue}from"./@vue.runtime-core-3a9e54b6.js";import{r as Ve,j as Ne,u as a}from"./@vue.reactivity-747ae439.js";import{o as R,O as S}from"./@vue.shared-9aa0355e.js";import{_ as De}from"./_plugin-vue_export-helper-c27b6911.js";import"./sortablejs-fc23419b.js";import"./dayjs-7a1ede46.js";import"./vue-70666ebd.js";import"./monaco-editor-63cfb1df.js";import"./store-2b1fd532.js";import"./axios-aba6f0e0.js";import"./nprogress-f3b783e1.js";import"./@vueuse.core-2f0af90d.js";import"./@vueuse.shared-8ce56883.js";import"./mitt-b509fb6d.js";import"./vue-router-19ed6b98.js";import"./pinia-9e37763f.js";import"./vue-demi-71ba0ef2.js";import"./vue-echarts-f1c2bb29.js";import"./resize-detector-a5205554.js";import"./echarts-be9a7bef.js";import"./tslib-54e39b60.js";import"./zrender-3d337fab.js";import"./mockjs-96a45e78.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-dee29e8b.js";import"./memoize-one-297ddbcb.js";import"./escape-html-1d60d822.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-7994f002.js";import"./@floating-ui.core-614032f8.js";import"./ts-wps-d32de3c6.js";const Fe={class:"cl-upload__item"},Pe={class:"cl-upload__text"},qe={class:"cl-upload__name"},Ae={class:"cl-upload__size"},Ie={class:"cl-upload__actions"},Ee={key:2,class:"cl-upload__progress"},Oe={key:3,class:"cl-upload__error"},Le=te({name:"cl-upload"}),Me=te({...Le,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,limitUpload:{type:Boolean,default:!0},size:[String,Number,Array],text:String,prefixPath:{type:String,default:"app"},menu:{type:String,default:"base"},showFileList:{type:Boolean,default:!0},draggable:Boolean,disabled:Boolean,customClass:String,beforeUpload:Function,isSpace:Boolean,isEdit:null,scope:null,isDisabled:Boolean},emits:["update:modelValue","upload","success","error","progress"],setup(d,{expose:ae,emit:C}){const s=d;pe(o=>({b4276bd8:a(K)[0],b4276b9a:a(K)[1]}));const{service:P,refs:z,setRefs:B}=be(),{user:le}=_e(),{options:$}=ge.get("upload"),K=v(()=>{const o=s.size||$.size;return(ee(o)?o:[o,o]).map(e=>ze(e)?e+"px":e)}),q=v(()=>s.isDisabled||s.disabled),A=v(()=>q.value||s.isSpace),G=s.limit||$.limit.upload,J=s.limitSize||$.limit.size,W=s.text||$.text,I=v(()=>({Authorization:le.token})),r=Ve([]),se=Ne({options:{group:"Upload",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:".is-drag",disabled:!s.draggable}}),U=v(()=>s.accept||(s.type=="file"?"*":"image/*")),E=v(()=>s.multiple?G-r.value.length>0:r.value.length==0);function H(o){var e;return s.type=="image"?"image":(e=Ce(o))==null?void 0:e.value}async function V(o,e){function i(){const t={type:H(o.name),preload:"",progress:0,url:o.url,uid:o.uid,size:o.size};return t.preload=t.url||(t.type=="image"?window.webkitURL.createObjectURL(o):o.name),e?Object.assign(e,t):s.multiple?(E.value||!s.limitUpload)&&r.value.push(t):r.value=[t],C("upload",t),!0}if(s.beforeUpload){const t=s.beforeUpload(o,e);return he(t)?t.then(i).catch(()=>null):t&&i(),t}else return o.size/1024/1024>=J?(T.error(`上传文件大小不能超过 ${J}MB!`),!1):i()}function Q(o){r.value.splice(o,1),N()}function X(){r.value=[]}function re(o){var e;o.type=="image"?(e=z.viewer)==null||e.open(o.preload,r.value.map(i=>i.preload)):window.open(o.url)}async function O(o,e){if(e||(e=r.value.find(t=>t.uid==o.file.uid)),!e)return!1;const i=M("");try{let t=i+"_"+o.file.name;const{mode:p,type:b}=await P.base.comm.uploadMode();return new Promise((L,D)=>{async function l({host:n,preview:_,data:Y}){const F=new FormData;for(const u in Y)F.append(u,Y[u]);p=="cloud"&&(t=[s.prefixPath,s.menu,t].filter(Boolean).join("/")),F.append("key",t),F.append("file",o.file),await P.request({url:n,method:"POST",headers:{"Content-Type":"multipart/form-data"},timeout:6e5,data:F,onUploadProgress(u){e.progress=parseInt(String(u.loaded/u.total*100)),C("progress",e)},proxy:p=="local"}).then(u=>{p==="local"?(e.url=u,e.key=u.replace(/^https?:\/\/[^\/]+/,"")):(e.url=`${_||n}/${t}`,e.key=t),e.fileId=i,e.name=e.preload,C("success",e),L(e.url),N()}).catch(u=>{T.error(u.message),e.error=u.message,C("error",e),D(u)})}p=="local"?l({host:"/admin/base/comm/upload"}):P.base.comm.upload().then(n=>{switch(b){case"cos":l({host:n.url,data:n.credentials});break;case"oss":l({host:n.host,data:{OSSAccessKeyId:n.OSSAccessKeyId,policy:n.policy,signature:n.signature}});break;case"qiniu":l({host:n.uploadUrl,preview:n.publicDomain,data:{token:n.token}});break}}).catch(D)})}catch{T.error("上传配置错误")}}function ie(){return r.value.find(o=>o.progress!=100)}function N(){r.value.find(e=>!e.url)||C("update:modelValue",ke(r.value))}function ne(o){var e,i,t;X(),(e=z.upload)==null||e.clearFiles(),(i=z.upload)==null||i.handleStart(o),(t=z.upload)==null||t.submit()}const y={data:null,open(o){var e;y.data=o,(e=z.space)==null||e.open({limit:o||!s.multiple?1:G})},onConfirm(o){o.forEach(e=>{V({uid:M(),...e},y.data)}),N(),y.data=null}};return xe(()=>s.modelValue,o=>{const e=(ee(o)?o:(o||"").split(",")).filter(Boolean),i=[];r.value=e.map(t=>{const p=r.value.find(b=>t==b.url&&!i.includes(b.uid));return p?(i.push(p.uid),p):{type:H(t),progress:0,uid:M(),url:t,preload:t}}).filter((t,p)=>s.multiple?!0:p==0)},{immediate:!0}),ae({isAdd:E,list:r,check:ie,clear:X,remove:Q,upload:ne}),(o,e)=>{const i=k("el-button"),t=k("el-upload"),p=k("el-icon"),b=k("el-image"),L=k("el-progress"),D=k("cl-upload-space");return c(),w(oe,null,[g("div",{class:R(["cl-upload__wrap",[d.customClass]])},[g("div",{class:R(["cl-upload",[`cl-upload--${d.type}`,{"is-disabled":a(q)}]])},[d.type=="file"?(c(),w("div",{key:0,class:"cl-upload__file-btn",onClick:e[0]||(e[0]=l=>y.open())},[m(t,{ref:a(B)("upload"),action:"",accept:a(U),"show-file-list":!1,"before-upload":V,"http-request":O,headers:a(I),multiple:d.multiple,disabled:a(A)},{default:f(()=>[j(o.$slots,"default",{},()=>[m(i,{type:"success"},{default:f(()=>[$e(S(a(W)),1)]),_:1})],!0)]),_:3},8,["accept","headers","multiple","disabled"])])):h("",!0),d.showFileList?(c(),x(a(ce),Be({key:1,class:"cl-upload__list",tag:"div",modelValue:r.value,"onUpdate:modelValue":e[2]||(e[2]=l=>r.value=l)},se.options,{"item-key":"uid",onEnd:N}),{footer:f(()=>[d.type=="image"&&a(E)?(c(),w("div",{key:0,class:"cl-upload__footer",onClick:e[1]||(e[1]=l=>y.open())},[m(t,{ref:a(B)("upload"),action:"",accept:a(U),"show-file-list":!1,"before-upload":V,"http-request":O,headers:a(I),multiple:d.multiple,disabled:a(A)},{default:f(()=>[j(o.$slots,"default",{},()=>[g("div",Fe,[m(p,{size:24},{default:f(()=>[m(a(de))]),_:1}),g("span",Pe,S(a(W)),1)])],!0)]),_:3},8,["accept","headers","multiple","disabled"])])):h("",!0)]),item:f(({element:l,index:n})=>[d.showFileList?(c(),x(t,{key:0,action:"",class:"is-drag",accept:a(U),"show-file-list":!1,"http-request":_=>O(_,l),"before-upload":_=>{V(_,l)},headers:a(I),disabled:a(A),onClick:_=>y.open(l)},{default:f(()=>[j(o.$slots,"item",{item:l,index:n},()=>[g("div",{class:R(["cl-upload__item",[`is-${l.type}`]])},[l.type=="image"?(c(),x(b,{key:0,src:l.preload,fit:"cover"},null,8,["src"])):(c(),w(oe,{key:1},[g("span",qe,S(a(we)(l.preload))+"."+S(a(ye)(l.preload)),1),g("span",Ae,S(a(Se)(l.size)),1)],64)),g("div",Ie,[Ue(m(p,{onClick:Z(_=>re(l),["stop"])},{default:f(()=>[m(a(me))]),_:2},1032,["onClick"]),[[ue,l.url]]),a(q)?h("",!0):(c(),x(p,{key:0,onClick:Z(_=>Q(n),["stop"])},{default:f(()=>[m(a(fe))]),_:2},1032,["onClick"]))]),l.progress>0&&l.progress<100?(c(),w("div",Ee,[m(L,{percentage:l.progress,"show-text":!1},null,8,["percentage"])])):h("",!0),l.error?(c(),w("div",Oe,S(l.error),1)):h("",!0)],2)],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled","onClick"])):h("",!0)]),_:3},16,["modelValue"])):h("",!0)],2)],2),m(ve,{ref:a(B)("viewer")},null,512),d.isSpace?(c(),x(D,{key:0,ref:a(B)("space"),"show-btn":!1,accept:a(U),onConfirm:y.onConfirm},null,8,["accept","onConfirm"])):h("",!0)],64)}}});const Uo=De(Me,[["__scopeId","data-v-e51727ac"]]);export{Uo as default};
